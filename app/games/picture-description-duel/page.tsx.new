"use client";
import { useState, useRef, useEffect } from "react";
import confetti from "canvas-confetti";

const QUESTIONS = [
  { id: 1, lang: "he", category: "animals", text: "××™×–×” ×—×™×” ×”×™× ×”×›×™ ×’×“×•×œ×”?", options: ["×—×ª×•×œ", "×›×œ×‘", "×¤×™×œ", "××¨× ×‘"], answer: 2, explanation: "×¤×™×œ ×”×•× ×”×—×™×” ×”×›×™ ×’×“×•×œ×” ××‘×™×Ÿ ×”××¤×©×¨×•×™×•×ª." },
  { id: 2, lang: "he", category: "food", text: "××™×–×” ×××›×œ ×¢×©×•×™ ××‘×™×¦×™×?", options: ["×œ×—×", "×—×‘×™×ª×”", "×¡×œ×˜", "××¨×§"], answer: 1, explanation: "×—×‘×™×ª×” ××•×›× ×” ××‘×™×¦×™×." },
  { id: 3, lang: "he", category: "school", text: "××” ××©××© ×œ×›×ª×™×‘×” ×¢×œ ×”×œ×•×—?", options: ["×¢×™×¤×¨×•×Ÿ", "×˜×•×©", "×’×™×¨", "×¢×˜"], answer: 2, explanation: "××©×ª××©×™× ×‘×’×™×¨ ×œ×›×ª×™×‘×” ×¢×œ ×”×œ×•×—." },
  { id: 4, lang: "he", category: "transport", text: "××™×–×” ×›×œ×™ ×ª×—×‘×•×¨×” × ×•×¡×¢ ×¢×œ ×¤×¡×™×?", options: ["××›×•× ×™×ª", "××•×¤× ×™×™×", "×¨×›×‘×ª", "××•×˜×•×‘×•×¡"], answer: 2, explanation: "×¨×›×‘×ª × ×•×¡×¢×ª ×¢×œ ×¤×¡×™×." },
  { id: 5, lang: "he", category: "nature", text: "××™×–×” ×¦×‘×¢ ×™×© ×œ×¢×¥ ×‘×¨×™×?", options: ["××“×•×", "×¦×”×•×‘", "×™×¨×•×§", "×›×—×•×œ"], answer: 2, explanation: "×¢×œ×™× ×©×œ ×¢×¥ ×‘×¨×™× ×”× ×‘×¦×‘×¢ ×™×¨×•×§." },
  { id: 6, lang: "he", category: "colors", text: "××™×–×” ×¦×‘×¢ ××§×‘×œ×™× ××¢×¨×‘×•×‘ ×©×œ ××“×•× ×•×›×—×•×œ?", options: ["×™×¨×•×§", "×¦×”×•×‘", "×¡×’×•×œ", "×›×ª×•×"], answer: 2, explanation: "×¢×¨×‘×•×‘ ×©×œ ××“×•× ×•×›×—×•×œ ×™×•×¦×¨ ×¡×’×•×œ." },
  { id: 7, lang: "he", category: "family", text: "××™ ×”×•× ×”××— ×©×œ ×××?", options: ["××‘×", "×¡×‘×", "×“×•×“", "×‘×Ÿ ×“×•×“"], answer: 2, explanation: "×”××— ×©×œ ××× ×”×•× ×”×“×•×“." },
  { id: 8, lang: "he", category: "sports", text: "××™×–×” ×¡×¤×•×¨×˜ ××©×—×§×™× ×¢× ×›×“×•×¨ ×¢×’×•×œ?", options: ["×›×“×•×¨×’×œ", "×›×“×•×¨×¡×œ", "×˜× ×™×¡", "×©×—×™×™×”"], answer: 0, explanation: "×›×“×•×¨×’×œ ××©×—×§×™× ×¢× ×›×“×•×¨ ×¢×’×•×œ." },
  { id: 9, lang: "he", category: "weather", text: "××ª×™ ×™×•×¨×“ ×’×©×?", options: ["×‘×§×™×¥", "×‘×—×•×¨×£", "×‘××‘×™×‘", "×‘×¡×ª×™×•"], answer: 1, explanation: "×’×©× ×™×•×¨×“ ×‘×¢×™×§×¨ ×‘×—×•×¨×£." },
  { id: 10, lang: "he", category: "time", text: "×›××” ×©×¢×•×ª ×™×© ×‘×™×××”?", options: ["12", "18", "24", "36"], answer: 2, explanation: "×‘×™×××” ×™×© 24 ×©×¢×•×ª." }
] as const;

const difficulties = [
  { key: "easy", label: "×§×œ", count: 5 },
  { key: "medium", label: "×‘×™× ×•× ×™", count: 10 },
  { key: "hard", label: "×§×©×”", count: 15 },
];

const CATEGORIES = [
  { key: "all", label: "×”×›×œ", icon: "ğŸŒˆ" },
  { key: "animals", label: "×‘×¢×œ×™ ×—×™×™×", icon: "ğŸ¾" },
  { key: "food", label: "××•×›×œ", icon: "ğŸ" },
  { key: "school", label: "×‘×™×ª ×¡×¤×¨", icon: "ğŸ«" },
  { key: "transport", label: "×ª×—×‘×•×¨×”", icon: "ğŸš—" },
  { key: "nature", label: "×˜×‘×¢", icon: "ğŸŒ¿" },
  { key: "colors", label: "×¦×‘×¢×™×", icon: "ğŸ¨" },
  { key: "family", label: "××©×¤×—×”", icon: "ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦" },
  { key: "sports", label: "×¡×¤×•×¨×˜", icon: "ğŸ…" },
  { key: "weather", label: "××–×’ ××•×•×™×¨", icon: "â›…" },
  { key: "time", label: "×–××Ÿ", icon: "â°" }
];

const getInitialTime = (difficulty: string): number => {
  switch (difficulty) {
    case 'easy': return 60;
    case 'medium': return 45;
    case 'hard': return 30;
    default: return 60;
  }
};

function getStats(name: string) {
  if (!name) return { games: 0, wins: 0, totalScore: 0 };
  try {
    return JSON.parse(localStorage.getItem('quiz-stats-' + name) || '{"games":0,"wins":0,"totalScore":0}');
  } catch {
    return { games: 0, wins: 0, totalScore: 0 };
  }
}

function setStats(name: string, stats: any) {
  if (!name) return;
  localStorage.setItem('quiz-stats-' + name, JSON.stringify(stats));
}

function pickQuestions(all: typeof QUESTIONS, lang: 'en' | 'he', count: number, category: string) {
  let pool = all.filter(q => q.lang === lang);
  if (category && category !== "all") pool = pool.filter(q => q.category === category);
  return pool.sort(() => Math.random() - 0.5).slice(0, count);
}

export default function PictureDescriptionDuel() {
  const [lang, setLang] = useState<'en' | 'he'>('he');
  const [difficulty, setDifficulty] = useState('easy');
  const [category, setCategory] = useState<string>("all");
  const [questions, setQuestions] = useState<typeof QUESTIONS>([]);
  const [current, setCurrent] = useState(0);
  const [score, setScore] = useState(0);
  const [selected, setSelected] = useState<number|null>(null);
  const [feedback, setFeedback] = useState<string|null>(null);
  const [showExplanation, setShowExplanation] = useState(false);
  const [finished, setFinished] = useState(false);
  const [stats, setStatsState] = useState({ total: 0, correct: 0, mistakes: 0 });
  const [personalBest, setPersonalBest] = useState<{score: number, accuracy: number} | null>(null);
  const [timer, setTimer] = useState(0);
  const confettiRef = useRef<HTMLDivElement>(null);
  const successAudio = useRef<HTMLAudioElement>(null);
  const failAudio = useRef<HTMLAudioElement>(null);
  const [categoryStats, setCategoryStats] = useState({});
  const [leaderboard, setLeaderboard] = useState([]);
  const [detailedResults, setDetailedResults] = useState([]);
  const [questionTimes, setQuestionTimes] = useState([]);
  const [countdown, setCountdown] = useState(getInitialTime(difficulty));
  const [timeUp, setTimeUp] = useState(false);
  const [playerName, setPlayerName] = useState("");
  const [inputName, setInputName] = useState("");

  useEffect(() => {
    const diff = difficulties.find(d => d.key === difficulty)!;
    setQuestions(pickQuestions(QUESTIONS, lang, diff.count, category));
    setCurrent(0);
    setScore(0);
    setSelected(null);
    setFeedback(null);
    setShowExplanation(false);
    setFinished(false);
    setStatsState({ total: 0, correct: 0, mistakes: 0 });
    setTimer(0);
    try {
      const pb = JSON.parse(localStorage.getItem('quiz-best') || 'null');
      if (pb) setPersonalBest(pb);
    } catch {}
    const stats = JSON.parse(localStorage.getItem('category-stats') || '{}');
    setCategoryStats(stats);
    const lb = JSON.parse(localStorage.getItem('leaderboard') || '[]');
    setLeaderboard(lb);
    setCountdown(getInitialTime(difficulty));
    setTimeUp(false);
  }, [difficulty, lang, category]);

  useEffect(() => {
    if (feedback === 'correct' && confettiRef.current) {
      confettiRef.current.classList.add('show');
      setTimeout(() => confettiRef.current?.classList.remove('show'), 1200);
    }
  }, [feedback]);

  useEffect(() => {
    if (finished) return;
    const interval = setInterval(() => setTimer(t => t + 1), 1000);
    return () => clearInterval(interval);
  }, [finished]);

  useEffect(() => {
    if (finished || timeUp) return;
    if (countdown <= 0) {
      setTimeUp(true);
      setFinished(true);
      return;
    }
    const interval = setInterval(() => setCountdown(t => t - 1), 1000);
    return () => clearInterval(interval);
  }, [finished, timeUp, countdown]);

  function handleSelect(idx: number) {
    if (selected !== null) return;
    setSelected(idx);
    setShowExplanation(true);
    setStatsState(s => ({ ...s, total: s.total + 1 }));
    const now = Date.now();
    setQuestionTimes(qt => [...qt, now]);
    const q = questions[current];
    setDetailedResults(dr => [...dr, { ...q, selected: idx, correct: idx === q.answer, time: now }]);
    setCategoryStats(cs => {
      const cat = q.category || 'other';
      const prev = cs[cat] || { total: 0, correct: 0 };
      const updated = { total: prev.total + 1, correct: prev.correct + (idx === q.answer ? 1 : 0) };
      const newStats = { ...cs, [cat]: updated };
      localStorage.setItem('category-stats', JSON.stringify(newStats));
      return newStats;
    });

    if (idx === q.answer) {
      setScore(s => s + 10);
      setFeedback('correct');
      setStatsState(s => ({ ...s, correct: s.correct + 1 }));
      if (successAudio.current) {
        successAudio.current.currentTime = 0;
        successAudio.current.play();
      }
      setTimeout(() => {
        setFeedback(null);
        setSelected(null);
        setShowExplanation(false);
        if (current === questions.length - 1) setFinished(true);
        else setCurrent(c => c + 1);
      }, 1400);
    } else {
      setFeedback('wrong');
      setStatsState(s => ({ ...s, mistakes: s.mistakes + 1 }));
      if (failAudio.current) {
        failAudio.current.currentTime = 0;
        failAudio.current.play();
      }
      setTimeout(() => setFeedback(null), 1200);
    }
  }

  function startGame() {
    setPlayerName(inputName || '×©×—×§×Ÿ');
    setQuestions(pickQuestions(QUESTIONS, lang, difficulties.find(d => d.key === difficulty)!.count, category));
    setCurrent(0);
    setScore(0);
    setSelected(null);
    setFeedback(null);
    setShowExplanation(false);
    setFinished(false);
    setStatsState({ total: 0, correct: 0, mistakes: 0 });
    setTimer(0);
    setCountdown(getInitialTime(difficulty));
    setTimeUp(false);
  }

  useEffect(() => {
    if (!finished) return;
    const accuracy = stats.total > 0 ? Math.round((stats.correct/stats.total)*100) : 0;
    if (!personalBest || score > personalBest.score || (score === personalBest.score && accuracy > personalBest.accuracy)) {
      const pb = { score, accuracy };
      setPersonalBest(pb);
      localStorage.setItem('quiz-best', JSON.stringify(pb));
    }
    const entry = { name: playerName, score };
    const lb = JSON.parse(localStorage.getItem('leaderboard') || '[]');
    lb.push(entry);
    lb.sort((a,b) => b.score - a.score);
    localStorage.setItem('leaderboard', JSON.stringify(lb));
    setLeaderboard(lb);
    const playerStats = getStats(playerName);
    playerStats.games++;
    playerStats.totalScore += score;
    if (score > 0) playerStats.wins++;
    setStats(playerName, playerStats);
    setStatsState(playerStats);
  }, [finished]);

  return (
    <main className="min-h-screen flex flex-col items-center justify-center p-4 bg-gradient-to-br from-blue-900 via-blue-700 to-purple-900">
      <audio ref={successAudio} src="/voice/success.mp3" preload="auto" />
      <audio ref={failAudio} src="/voice/fail.mp3" preload="auto" />
      <div ref={confettiRef} className="confetti" />
      <div className="max-w-2xl w-full mx-auto bg-white bg-opacity-95 rounded-3xl shadow-2xl p-8 transition-all duration-700">
        <h1 className="text-3xl md:text-4xl font-extrabold text-blue-700 text-center mb-6">×—×™×“×•×Ÿ ××¢×•×¨×‘</h1>
        {!playerName && (
          <div className="flex flex-col gap-4 items-center">
            <div className="flex gap-2 mb-2">
              <button onClick={()=>setLang('he')} className={`px-4 py-2 rounded-full font-bold ${lang==='he'?'bg-pink-600 text-white':'bg-white text-pink-700'}`}>×¢×‘×¨×™×ª</button>
              <button onClick={()=>setLang('en')} className={`px-4 py-2 rounded-full font-bold ${lang==='en'?'bg-green-600 text-white':'bg-white text-green-700'}`}>English</button>
            </div>
            <div className="flex flex-col gap-2">
              <input value={inputName} onChange={e=>setInputName(e.target.value)} placeholder="×©× ×©×—×§×Ÿ" className="border rounded px-4 py-2" />
              <select value={difficulty} onChange={e=>setDifficulty(e.target.value)} className="border rounded px-4 py-2">
                {difficulties.map(d => <option key={d.key} value={d.key}>{d.label}</option>)}
              </select>
              <select value={category} onChange={e=>setCategory(e.target.value)} className="border rounded px-4 py-2">
                {CATEGORIES.map(c => <option key={c.key} value={c.key}>{c.label}</option>)}
              </select>
              <button onClick={startGame} className="bg-blue-500 text-white px-6 py-2 rounded font-bold mt-2">×”×ª×—×œ ××©×—×§</button>
            </div>
          </div>
        )}
        {playerName && !finished && questions.length > 0 && (
          <div className="flex flex-col gap-4 items-center mt-4">
            <div className="w-full h-4 bg-blue-100 rounded-full mb-6 overflow-hidden relative">
              <div className="h-full bg-gradient-to-r from-green-400 to-blue-500 transition-all duration-700" style={{ width: `${((current+1)/questions.length)*100}%` }} />
              <div className="absolute inset-0 flex items-center justify-center text-blue-700 font-bold text-sm">{current+1}/{questions.length}</div>
            </div>
            <div className="flex justify-between w-full mb-4">
              <div className="bg-blue-100 px-4 py-2 rounded-xl font-bold">× ×™×§×•×“: {score}</div>
              <div className="bg-red-100 px-4 py-2 rounded-xl font-bold">×–××Ÿ: {countdown}</div>
            </div>
            <div className="bg-gradient-to-r from-blue-200 to-purple-200 rounded-xl shadow p-4 mb-4 text-xl font-bold text-blue-900 text-center animate-fade-in">
              {questions[current].text}
            </div>
            <div className="flex flex-col gap-3 mb-4">
              {questions[current].options.map((opt, idx) => (
                <button key={idx} onClick={() => handleSelect(idx)} disabled={selected !== null}
                  className={`w-full px-6 py-3 rounded-2xl font-bold text-lg shadow transition-all duration-200 border-2 flex items-center gap-2
                    ${selected === idx
                      ? idx === questions[current].answer
                        ? 'bg-green-200 border-green-500 text-green-900 scale-105'
                        : 'bg-red-200 border-red-500 text-red-900 shake'
                      : 'bg-white border-blue-200 text-blue-900 hover:bg-blue-50 hover:scale-105'}`}
                >{opt}</button>
              ))}
            </div>
            {feedback === 'correct' && (
              <div className="flex flex-col items-center justify-center animate-fade-in">
                <div className="bg-white border-2 border-green-400 rounded-2xl px-8 py-6 text-2xl font-bold text-green-700 shadow-lg flex items-center gap-2 mb-2">
                  <span>ğŸ‰</span> × ×›×•×Ÿ! <span>ğŸ‰</span>
                </div>
              </div>
            )}
            {feedback === 'wrong' && (
              <div className="flex flex-col items-center justify-center animate-fade-in">
                <div className="bg-white border-2 border-red-400 rounded-2xl px-8 py-6 text-2xl font-bold text-red-700 shadow-lg flex items-center gap-2 mb-2">
                  <span>âŒ</span> ×œ× × ×›×•×Ÿ <span>âŒ</span>
                </div>
              </div>
            )}
            {showExplanation && (
              <div className="bg-green-100 border-l-4 border-green-400 rounded-xl px-6 py-3 text-md font-bold text-green-900 shadow mb-2 animate-fade-in">
                {questions[current].explanation}
              </div>
            )}
          </div>
        )}
        {finished && (
          <div className="text-center mt-6 animate-fade-in">
            <div className="text-2xl font-bold text-blue-700 mb-4 flex items-center justify-center gap-2">
              <span className="text-green-500 text-3xl">ğŸ†</span> ×›×œ ×”×›×‘×•×“! ×¡×™×™××ª ××ª ×”×—×™×“×•×Ÿ ğŸ‰
            </div>
            <div className="text-lg font-bold text-green-700 mb-2 flex items-center justify-center gap-2">
              <span className="text-blue-500 text-2xl">â˜…</span> × ×™×§×•×“ ×¡×•×¤×™: {score} | {stats.total > 0 ? Math.round((stats.correct/stats.total)*100) : 0}% ×”×¦×œ×—×”
            </div>
            <div className="text-md font-bold text-purple-700 mb-2 flex items-center justify-center gap-2">
              {stats.correct} ×ª×©×•×‘×•×ª × ×›×•× ×•×ª, {stats.mistakes} ×˜×¢×•×™×•×ª, {stats.total} ×©××œ×•×ª
            </div>
            <button onClick={()=>{setPlayerName("");setInputName("");}} className="bg-gradient-to-r from-yellow-400 via-green-400 to-blue-500 text-white px-8 py-3 rounded-full text-xl font-bold shadow-lg mt-4 flex items-center gap-2">
              <span className="text-2xl">ğŸ”„</span> ×©×—×§ ×©×•×‘
            </button>
            <div className="bg-white bg-opacity-80 rounded-xl p-4 mt-4">
              <div className="font-bold text-purple-700 mb-2">×“×™×¨×•×’ ×©×—×§× ×™× (××§×•××™):</div>
              <ol className="list-decimal ml-6">
                {leaderboard.slice(0,5).map((entry,i) => (
                  <li key={i}>{entry.name || '×©×—×§×Ÿ'}: {entry.score} × ×§×³</li>
                ))}
              </ol>
            </div>
          </div>
        )}
      </div>
      <style>{`
      @keyframes fade-in { from{opacity:0;transform:translateY(30px);} to{opacity:1;transform:translateY(0);} }
      .animate-fade-in { animation: fade-in 1s cubic-bezier(.4,0,.2,1) both; }
      @keyframes bounce { 0%,100%{transform:scale(1);} 50%{transform:scale(1.15);} }
      .animate-bounce { animation: bounce 0.7s; }
      @keyframes shake { 0%{transform:translateX(0);} 20%{transform:translateX(-8px);} 40%{transform:translateX(8px);} 60%{transform:translateX(-8px);} 80%{transform:translateX(8px);} 100%{transform:translateX(0);} }
      .animate-shake { animation: shake 0.4s; }
      .confetti { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1000; opacity: 0; transition: opacity 0.3s; }
      .confetti.show { opacity: 1; }
      `}</style>
    </main>
  );
} 